//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using NHibernate.Cfg;
using NHibernate.Context;
using NHibernate.Engine;
using NUnit.Framework;

namespace NHibernate.Test.ConnectionTest
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture,Ignore("Not yet supported. Need AutoClosed feature.(TransactionContext)")]
	public class ThreadLocalCurrentSessionTestAsync : ConnectionManagementTestCase
	{
		protected override ISession GetSessionUnderTest()
		{
			ISession session = OpenSession();
			session.BeginTransaction();
			return session;
		}

		protected override void Configure(Configuration configuration)
		{
			base.Configure(cfg);
			cfg.SetProperty(Environment.CurrentSessionContextClass, typeof (TestableThreadLocalContext).AssemblyQualifiedName);
			cfg.SetProperty(Environment.GenerateStatistics, "true");
		}

		protected override void Release(ISession session)
		{
			long initialCount = sessions.Statistics.SessionCloseCount;
			session.Transaction.Commit();
			long subsequentCount = sessions.Statistics.SessionCloseCount;
			Assert.AreEqual(initialCount + 1, subsequentCount, "Session still open after commit");
			// also make sure it was cleaned up from the internal ThreadLocal...
			Assert.IsFalse(TestableThreadLocalContext.HasBind(), "session still bound to internal ThreadLocal");
		}

		//TODO: Need AutoCloseEnabled feature after commit.
		[Test]
		public async Task ContextCleanupAsync()
		{
			ISession session = sessions.OpenSession();
			session.BeginTransaction();
			await (session.Transaction.CommitAsync(CancellationToken.None));
			Assert.IsFalse(session.IsOpen, "session open after txn completion");
			Assert.IsFalse(TestableThreadLocalContext.IsSessionBound(session), "session still bound after txn completion");
			
			ISession session2 = OpenSession();
			Assert.IsFalse(session.Equals(session2), "same session returned after txn completion");
			session2.Close();
			Assert.IsFalse(session2.IsOpen, "session open after closing");
			Assert.IsFalse(TestableThreadLocalContext.IsSessionBound(session2), "session still bound after closing");
		}
	}
}