//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Collections.Generic;
using log4net;
using log4net.Core;
using NUnit.Framework;

namespace NHibernate.Test.IdTest
{
	using System.Threading.Tasks;
	using System.Threading;

	[TestFixture]
	public class AssignedFixtureAsync : IdFixtureBase
	{

		private string[] GetAssignedIdentifierWarnings(LogSpy ls)
		{
			List<string> warnings = new List<string>();

			foreach (string logEntry in ls.GetWholeLog().Split('\n'))
				if (logEntry.Contains("Unable to determine if") && logEntry.Contains("is transient or detached"))
					warnings.Add(logEntry);

			return warnings.ToArray();
		}

		protected override string TypeName
		{
			get { return "Assigned"; }
		}

		protected override void OnTearDown()
		{
			base.OnTearDown();

			using (ISession s = OpenSession())
			using (ITransaction t = s.BeginTransaction())
			{
				s.CreateQuery("delete from Child").ExecuteUpdate();
				s.CreateQuery("delete from Parent").ExecuteUpdate();
				t.Commit();
			}
		}

		[Test]
		public async Task SaveOrUpdate_SaveAsync()
		{
			using (LogSpy ls = new LogSpy(LogManager.GetLogger("NHibernate"), Level.Warn))
			using (ISession s = OpenSession())
			{
				ITransaction t = s.BeginTransaction();

				Parent parent =
					new Parent()
					{
						Id = "parent",
						Children = new List<Child>(),
					};

				await (s.SaveOrUpdateAsync(parent, CancellationToken.None));
				await (t.CommitAsync(CancellationToken.None));

				long actual = await (s.CreateQuery("select count(p) from Parent p").UniqueResultAsync<long>(CancellationToken.None));
				Assert.That(actual, Is.EqualTo(1));

				string[] warnings = GetAssignedIdentifierWarnings(ls);
				Assert.That(warnings.Length, Is.EqualTo(1));
				Assert.IsTrue(warnings[0].Contains("parent"));
			}
		}

		[Test]
		public async Task SaveNoWarningAsync()
		{
			using (LogSpy ls = new LogSpy(LogManager.GetLogger("NHibernate"), Level.Warn))
			using (ISession s = OpenSession())
			{
				ITransaction t = s.BeginTransaction();

				Parent parent =
					new Parent()
					{
						Id = "parent",
						Children = new List<Child>(),
					};

				await (s.SaveAsync(parent, CancellationToken.None));
				await (t.CommitAsync(CancellationToken.None));

				long actual = await (s.CreateQuery("select count(p) from Parent p").UniqueResultAsync<long>(CancellationToken.None));
				Assert.That(actual, Is.EqualTo(1));

				string[] warnings = GetAssignedIdentifierWarnings(ls);
				Assert.That(warnings.Length, Is.EqualTo(0));
			}
		}

		[Test]
		public async Task SaveOrUpdate_UpdateAsync()
		{
			using (ISession s = OpenSession())
			{
				ITransaction t = s.BeginTransaction();

				await (s.SaveAsync(new Parent() { Id = "parent", Name = "before" }, CancellationToken.None));
				await (t.CommitAsync(CancellationToken.None));
			}

			using (LogSpy ls = new LogSpy(LogManager.GetLogger("NHibernate"), Level.Warn))
			using (ISession s = OpenSession())
			{
				ITransaction t = s.BeginTransaction();

				Parent parent =
					new Parent()
					{
						Id = "parent",
						Name = "after",
					};

				await (s.SaveOrUpdateAsync(parent, CancellationToken.None));
				await (t.CommitAsync(CancellationToken.None));

				string[] warnings = GetAssignedIdentifierWarnings(ls);
				Assert.That(warnings.Length, Is.EqualTo(1));
				Assert.IsTrue(warnings[0].Contains("parent"));
			}

			using (ISession s = OpenSession())
			{
				Parent parent = await (s.CreateQuery("from Parent").UniqueResultAsync<Parent>(CancellationToken.None));
				Assert.That(parent.Name, Is.EqualTo("after"));
			}
		}

		[Test]
		public async Task UpdateNoWarningAsync()
		{
			using (ISession s = OpenSession())
			{
				ITransaction t = s.BeginTransaction();

				await (s.SaveAsync(new Parent() { Id = "parent", Name = "before" }, CancellationToken.None));
				await (t.CommitAsync(CancellationToken.None));
			}

			using (LogSpy ls = new LogSpy(LogManager.GetLogger("NHibernate"), Level.Warn))
			using (ISession s = OpenSession())
			{
				ITransaction t = s.BeginTransaction();

				Parent parent =
					new Parent()
					{
						Id = "parent",
						Name = "after",
					};

				await (s.UpdateAsync(parent, CancellationToken.None));
				await (t.CommitAsync(CancellationToken.None));

				string[] warnings = GetAssignedIdentifierWarnings(ls);
				Assert.That(warnings.Length, Is.EqualTo(0));
			}

			using (ISession s = OpenSession())
			{
				Parent parent = await (s.CreateQuery("from Parent").UniqueResultAsync<Parent>(CancellationToken.None));
				Assert.That(parent.Name, Is.EqualTo("after"));
			}
		}

		[Test]
		public async Task InsertCascadeAsync()
		{
			using (ISession s = OpenSession())
			{
				ITransaction t = s.BeginTransaction();

				await (s.SaveAsync(new Child() { Id = "detachedChild" }, CancellationToken.None));
				await (t.CommitAsync(CancellationToken.None));
			}

			using (LogSpy ls = new LogSpy(LogManager.GetLogger("NHibernate"), Level.Warn))
			using (ISession s = OpenSession())
			{
				ITransaction t = s.BeginTransaction();

				Parent parent =
					new Parent()
					{
						Id = "parent",
						Children = new List<Child>(),
					};

				parent.Children.Add(new Child() { Id = "detachedChild", Parent = parent });
				parent.Children.Add(new Child() { Id = "transientChild", Parent = parent });

				await (s.SaveAsync(parent, CancellationToken.None));
				await (t.CommitAsync(CancellationToken.None));

				long actual = await (s.CreateQuery("select count(c) from Child c").UniqueResultAsync<long>(CancellationToken.None));
				Assert.That(actual, Is.EqualTo(2));

				string[] warnings = GetAssignedIdentifierWarnings(ls);
				Assert.That(warnings.Length, Is.EqualTo(2));
				Assert.IsTrue(warnings[0].Contains("detachedChild"));
				Assert.IsTrue(warnings[1].Contains("transientChild"));
			}
		}

		[Test]
		public async Task InsertCascadeNoWarningAsync()
		{
			using (ISession s = OpenSession())
			{
				ITransaction t = s.BeginTransaction();

				await (s.SaveAsync(new Child() { Id = "persistedChild" }, CancellationToken.None));
				await (t.CommitAsync(CancellationToken.None));
			}

			using (LogSpy ls = new LogSpy(LogManager.GetLogger("NHibernate"), Level.Warn))
			using (ISession s = OpenSession())
			{
				ITransaction t = s.BeginTransaction();

				Parent parent =
					new Parent()
					{
						Id = "parent",
						Children = new List<Child>(),
					};

				await (s.SaveAsync(parent, CancellationToken.None));

				Child child1 = await (s.LoadAsync<Child>("persistedChild", CancellationToken.None));
				child1.Parent = parent;
				parent.Children.Add(child1);

				Child child2 = new Child() { Id = "transientChild", Parent = parent };
				await (s.SaveAsync(child2, CancellationToken.None));
				parent.Children.Add(child2);

				await (t.CommitAsync(CancellationToken.None));

				long actual = await (s.CreateQuery("select count(c) from Child c").UniqueResultAsync<long>(CancellationToken.None));
				Assert.That(actual, Is.EqualTo(2));

				string[] warnings = GetAssignedIdentifierWarnings(ls);
				Assert.That(warnings.Length, Is.EqualTo(0));
			}
		}

	}

}
