//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Collections;
using System.Reflection;
using NHibernate.Cfg;
using NHibernate.Criterion;
using NUnit.Framework;
using Environment=NHibernate.Cfg.Environment;

namespace NHibernate.Test.Naturalid.Mutable
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class MutableNaturalIdFixtureAsync : TestCase
	{
		protected override string MappingsAssembly
		{
			get { return "NHibernate.Test"; }
		}

		protected override IList Mappings
		{
			get { return new string[] {"Naturalid.Mutable.User.hbm.xml"}; }
		}

		protected override void Configure(Configuration configuration)
		{
			cfg.SetProperty(Environment.UseSecondLevelCache, "true");
			cfg.SetProperty(Environment.UseQueryCache, "true");
			cfg.SetProperty(Environment.GenerateStatistics, "true");
		}

		[Test]
		public async Task ReattachmentNaturalIdCheckAsync()
		{
			ISession s = OpenSession();
			s.BeginTransaction();
			User u = new User("gavin", "hb", "secret");
			await (s.PersistAsync(u, CancellationToken.None));
			await (s.Transaction.CommitAsync(CancellationToken.None));
			s.Close();

			FieldInfo name = u.GetType().GetField("name",
			                                      BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.DeclaredOnly);
			name.SetValue(u, "Gavin");
			s = OpenSession();
			s.BeginTransaction();
			try
			{
				await (s.UpdateAsync(u, CancellationToken.None));
				await (s.Transaction.CommitAsync(CancellationToken.None));
			}
			catch (HibernateException)
			{
				s.Transaction.Rollback();
			}
			catch (Exception)
			{
					s.Transaction.Rollback();
			}
			finally
			{
				s.Close();
			}

			s = OpenSession();
			s.BeginTransaction();
			await (s.DeleteAsync(u, CancellationToken.None));
			await (s.Transaction.CommitAsync(CancellationToken.None));
			s.Close();
		}

		[Test]
		public async Task NonexistentNaturalIdCacheAsync()
		{
			sessions.Statistics.Clear();

			ISession s = OpenSession();
			ITransaction t = s.BeginTransaction();

			object nullUser =
				await (s.CreateCriteria(typeof (User)).Add(Restrictions.NaturalId().Set("name", "gavin").Set("org", "hb")).SetCacheable(
					true).UniqueResultAsync(CancellationToken.None));

			Assert.That(nullUser, Is.Null);

			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			Assert.AreEqual(1, sessions.Statistics.QueryExecutionCount);
			Assert.AreEqual(0, sessions.Statistics.QueryCacheHitCount);
			Assert.AreEqual(0, sessions.Statistics.QueryCachePutCount);

			s = OpenSession();
			t = s.BeginTransaction();

			User u = new User("gavin", "hb", "secret");
			await (s.PersistAsync(u, CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			sessions.Statistics.Clear();

			s = OpenSession();
			t = s.BeginTransaction();

			u =
				(User)
				await (s.CreateCriteria(typeof (User)).Add(Restrictions.NaturalId().Set("name", "gavin").Set("org", "hb")).SetCacheable(
					true).UniqueResultAsync(CancellationToken.None));

			Assert.That(u, Is.Not.Null);

			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			Assert.AreEqual(1, sessions.Statistics.QueryExecutionCount);
			Assert.AreEqual(0, sessions.Statistics.QueryCacheHitCount);
			Assert.AreEqual(1, sessions.Statistics.QueryCachePutCount);

			sessions.Statistics.Clear();

			s = OpenSession();
			t = s.BeginTransaction();

			u =
				(User)
				await (s.CreateCriteria(typeof (User)).Add(Restrictions.NaturalId().Set("name", "gavin").Set("org", "hb")).SetCacheable(
					true).UniqueResultAsync(CancellationToken.None));

			await (s.DeleteAsync(u, CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			Assert.AreEqual(0, sessions.Statistics.QueryExecutionCount);
			Assert.AreEqual(1, sessions.Statistics.QueryCacheHitCount);

			sessions.Statistics.Clear();

			s = OpenSession();
			t = s.BeginTransaction();

			nullUser =
				await (s.CreateCriteria(typeof (User)).Add(Restrictions.NaturalId().Set("name", "gavin").Set("org", "hb")).SetCacheable(
					true).UniqueResultAsync(CancellationToken.None));

			Assert.That(nullUser, Is.Null);

			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			Assert.AreEqual(1, sessions.Statistics.QueryExecutionCount);
			Assert.AreEqual(0, sessions.Statistics.QueryCacheHitCount);
			Assert.AreEqual(0, sessions.Statistics.QueryCachePutCount);
		}

		[Test]
		public async Task NaturalIdCacheAsync()
		{
			ISession s = OpenSession();
			ITransaction t = s.BeginTransaction();

			User u = new User("gavin", "hb", "secret");
			await (s.PersistAsync(u, CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			sessions.Statistics.Clear();

			s = OpenSession();
			t = s.BeginTransaction();

			u = (User) await (s.CreateCriteria(typeof (User))
				.Add(Restrictions.NaturalId().Set("name", "gavin").Set("org", "hb"))
				.SetCacheable(true).UniqueResultAsync(CancellationToken.None));

			Assert.That(u, Is.Not.Null);

			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			Assert.AreEqual(1, sessions.Statistics.QueryExecutionCount);
			Assert.AreEqual(0, sessions.Statistics.QueryCacheHitCount);
			Assert.AreEqual(1, sessions.Statistics.QueryCachePutCount);

			s = OpenSession();
			t = s.BeginTransaction();

			User v = new User("xam", "hb", "foobar");
			await (s.PersistAsync(v, CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			sessions.Statistics.Clear();

			s = OpenSession();
			t = s.BeginTransaction();

			u = (User) await (s.CreateCriteria(typeof (User))
				.Add(Restrictions.NaturalId().Set("name", "xam").Set("org", "hb"))
				.SetCacheable(true).UniqueResultAsync(CancellationToken.None));

			Assert.That(u, Is.Not.Null);
			Assert.AreEqual(1, sessions.Statistics.QueryExecutionCount);
			Assert.AreEqual(0, sessions.Statistics.QueryCacheHitCount);

			u = (User)await (s.CreateCriteria(typeof(User))
				.Add(Restrictions.NaturalId().Set("name", "gavin").Set("org", "hb"))
				.SetCacheable(true).UniqueResultAsync(CancellationToken.None));
			Assert.That(u, Is.Not.Null);
			Assert.AreEqual(1, sessions.Statistics.QueryExecutionCount);
			Assert.AreEqual(1, sessions.Statistics.QueryCacheHitCount);

			await (t.CommitAsync(CancellationToken.None));
			s.Close();


			s = OpenSession();
			t = s.BeginTransaction();
			await (s.DeleteAsync("from User", CancellationToken.None));
			await (t.CommitAsync(CancellationToken.None));
			s.Close();
		}

		[Test]
		public async Task QueryingAsync()
		{
			ISession s = OpenSession();
			ITransaction t = s.BeginTransaction();

			User u = new User("emmanuel", "hb", "bh");
			await (s.PersistAsync(u, CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			s = OpenSession();
			t = s.BeginTransaction();

			u = (User) await (s.CreateQuery("from User u where u.name = :name").SetParameter("name", "emmanuel").UniqueResultAsync(CancellationToken.None));
			Assert.AreEqual("emmanuel", u.Name);
			await (s.DeleteAsync(u, CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();
		}
	}
}