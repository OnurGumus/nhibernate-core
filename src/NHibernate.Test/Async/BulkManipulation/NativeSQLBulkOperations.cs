//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Collections;
using NUnit.Framework;

namespace NHibernate.Test.BulkManipulation
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class NativeSQLBulkOperationsAsync : TestCase
	{
		protected override string MappingsAssembly
		{
			get { return "NHibernate.Test"; }
		}

		protected override IList Mappings
		{
			get { return new string[] { "BulkManipulation.Vehicle.hbm.xml" }; }
		}

		[Test]
		public async Task SimpleNativeSQLInsertAsync()
		{
			await (PrepareDataAsync(CancellationToken.None));

			ISession s = OpenSession();
			ITransaction t = s.BeginTransaction();
			IList l = await (s.CreateQuery("from Vehicle").ListAsync(CancellationToken.None));
			Assert.AreEqual(4, l.Count);

			string ssql =
				string.Format("insert into VEHICLE (id, TofC, Vin, Owner) select {0}, 22, Vin, Owner from VEHICLE where TofC = 10",
				              GetNewId());
			await (s.CreateSQLQuery(ssql).ExecuteUpdateAsync(CancellationToken.None));
			l = await (s.CreateQuery("from Vehicle").ListAsync(CancellationToken.None));
			Assert.AreEqual(5, l.Count);

			await (t.CommitAsync(CancellationToken.None));
			t = s.BeginTransaction();

			await (s.CreateSQLQuery("delete from VEHICLE where TofC = 20").ExecuteUpdateAsync(CancellationToken.None));

			l = await (s.CreateQuery("from Vehicle").ListAsync(CancellationToken.None));
			Assert.AreEqual(4, l.Count);

			Car c = await (s.CreateQuery("from Car c where c.Owner = 'Kirsten'").UniqueResultAsync<Car>(CancellationToken.None));
			c.Owner = "NotKirsten";
			IQuery sql = s.GetNamedQuery("native-delete-car").SetString(0, "Kirsten");
			Assert.AreEqual(0, await (sql.ExecuteUpdateAsync(CancellationToken.None)));

			sql = s.GetNamedQuery("native-delete-car").SetString(0, "NotKirsten");
			Assert.AreEqual(1, await (sql.ExecuteUpdateAsync(CancellationToken.None)));

			sql = s.CreateSQLQuery("delete from VEHICLE where (TofC = 21) and (Owner = :owner)").SetString("owner", "NotThere");
			Assert.AreEqual(0, await (sql.ExecuteUpdateAsync(CancellationToken.None)));

			sql = s.CreateSQLQuery("delete from VEHICLE where (TofC = 21) and (Owner = :owner)").SetString("owner", "Joe");
			Assert.AreEqual(1, await (sql.ExecuteUpdateAsync(CancellationToken.None)));

			await (s.CreateSQLQuery("delete from VEHICLE where (TofC = 22)").ExecuteUpdateAsync(CancellationToken.None));

			l = await (s.CreateQuery("from Vehicle").ListAsync(CancellationToken.None));
			Assert.AreEqual(0, l.Count);

			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			await (CleanupDataAsync(CancellationToken.None));
		}

		private int customId = 0;
		private int GetNewId()
		{
			return ++customId;
		}
		public async Task PrepareDataAsync(CancellationToken cancellationToken = default(CancellationToken))
		{
			ISession s = OpenSession();
			ITransaction txn = s.BeginTransaction();

			Car car = new Car();
			car.Id = GetNewId();
			car.Vin="123c";
			car.Owner="Kirsten";
			await (s.SaveAsync(car, cancellationToken));

			Truck truck = new Truck();
			truck.Id = GetNewId();
			truck.Vin = "123t";
			truck.Owner="Steve";
			await (s.SaveAsync(truck, cancellationToken));

			SUV suv = new SUV();
			suv.Id = GetNewId();
			suv.Vin = "123s";
			suv.Owner="Joe";
			await (s.SaveAsync(suv, cancellationToken));

			Pickup pickup = new Pickup();
			pickup.Id = GetNewId();
			pickup.Vin = "123p";
			pickup.Owner="Cecelia";
			await (s.SaveAsync(pickup, cancellationToken));

			await (txn.CommitAsync(cancellationToken));
			s.Close();
		}

		public async Task CleanupDataAsync(CancellationToken cancellationToken = default(CancellationToken))
		{
			ISession s = OpenSession();
			ITransaction txn = s.BeginTransaction();

			await (s.DeleteAsync("from Vehicle", cancellationToken));

			await (txn.CommitAsync(cancellationToken));
			s.Close();
		}
	}
}