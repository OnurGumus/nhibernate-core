//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Collections;
using System.Collections.Generic;
using NHibernate.Cfg;
using NHibernate.Stat;
using NUnit.Framework;

namespace NHibernate.Test.Ondelete
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class ParentChildFixtureAsync : TestCase
	{
		protected override string MappingsAssembly
		{
			get { return "NHibernate.Test"; }
		}

		protected override IList Mappings
		{
			get { return new string[] { "Ondelete.ParentChild.hbm.xml" }; }
		}

		protected override void Configure(Configuration cfg)
		{
			cfg.SetProperty(Environment.GenerateStatistics, "true");
		}

		[Test]
		public async Task ParentChildCascadeAsync()
		{
			ISession s = OpenSession();
			ITransaction t = s.BeginTransaction();
			Parent p = new Parent("foo");
			p.Children.Add(new Child(p, "foo1"));
			p.Children.Add(new Child(p, "foo2"));
			Parent q = new Parent("bar");
			q.Children.Add(new Child(q, "bar1"));
			q.Children.Add(new Child(q, "bar2"));
			await (s.SaveAsync(p, CancellationToken.None));
			await (s.SaveAsync(q, CancellationToken.None));
			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			IStatistics statistics = sessions.Statistics;
			statistics.Clear();

			s = OpenSession();
			t = s.BeginTransaction();
			IList<Parent> l = await (s.CreateQuery("from Parent").ListAsync<Parent>(CancellationToken.None));
			p = l[0];
			q = l[1];
			statistics.Clear();

			await (s.DeleteAsync(p, CancellationToken.None));
			await (s.DeleteAsync(q, CancellationToken.None));
			await (t.CommitAsync(CancellationToken.None));

			Assert.AreEqual(2, statistics.PrepareStatementCount);
			Assert.AreEqual(6, statistics.EntityDeleteCount);

			t = s.BeginTransaction();
			IList names = await (s.CreateQuery("from Parent p").ListAsync(CancellationToken.None));
			Assert.AreEqual(0, names.Count);

			await (t.CommitAsync(CancellationToken.None));
			s.Close();
		}
	}
}
