//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using NHibernate.Dialect;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.NH1714
{
    using System.Threading.Tasks;
    using System.Threading;
    [TestFixture]
    public class SimpleReproductionFixtureAsync : BugTestCase
    {
        protected override bool AppliesTo(NHibernate.Dialect.Dialect dialect)
        {
            return dialect as MsSql2005Dialect != null;
        }

        [Test]
        public async Task DbCommandsFromEventListenerShouldBeEnlistedInRunningTransactionAsync()
        {
            using (ISession session = OpenSession())
            {
                using (var tx = session.BeginTransaction())
                {
                    var entity = new DomainClass();
                    await (session.SaveAsync(entity, CancellationToken.None));

                    using (var otherSession = session.GetChildSession())
                    {
                        await (otherSession.SaveAsync(new DomainClass(), CancellationToken.None));
                        await (otherSession.FlushAsync(CancellationToken.None));
                    }

                    await (tx.CommitAsync(CancellationToken.None));
                }
            }

			using(var session = OpenSession())
			using (var tx = session.BeginTransaction())
			{
				await (session.DeleteAsync("from DomainClass", CancellationToken.None));
				await (tx.CommitAsync(CancellationToken.None));
			}
        }
    }
}