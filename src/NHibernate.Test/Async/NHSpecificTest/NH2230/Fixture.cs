//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Linq;
using NUnit.Framework;
using System.Collections.Generic;

namespace NHibernate.Test.NHSpecificTest.NH2230
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class FixtureAsync : BugTestCase
	{
		[Test]
		public async Task CanCreacteRetrieveDeleteComponentsWithPrivateReferenceSetterToParentAsync()
		{
			var entity = new MyEntity();
			var component = new MyComponentWithParent(entity){Something = "A"};
			entity.Component = component;
			entity.Children = new List<MyComponentWithParent>
								{
									new MyComponentWithParent(entity){Something = "B"},
														new MyComponentWithParent(entity){Something = "C"}
								};
			object poid;
			using (var s = OpenSession())
			using (var tx = s.BeginTransaction())
			{
				poid = await (s.SaveAsync(entity, CancellationToken.None));
				await (tx.CommitAsync(CancellationToken.None));
			}

			using (var s = OpenSession())
			using (var tx = s.BeginTransaction())
			{
				var savedEntity = await (s.GetAsync<MyEntity>(poid, CancellationToken.None));
				var myComponentWithParent = savedEntity.Component;
				Assert.That(myComponentWithParent, Is.Not.Null);
				Assert.That(myComponentWithParent.Parent, Is.SameAs(savedEntity));
				Assert.That(myComponentWithParent.Something, Is.EqualTo("A"));

				Assert.That(savedEntity.Children.Select(c => c.Something), Is.EquivalentTo(new [] {"B", "C"}));
				Assert.That(savedEntity.Children.All(c => ReferenceEquals(c.Parent, savedEntity)), Is.True);

				await (s.DeleteAsync(savedEntity, CancellationToken.None));
				await (tx.CommitAsync(CancellationToken.None));
			}
		}
	}
}