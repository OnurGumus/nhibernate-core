//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Collections;
using NHibernate.Cfg;
using NHibernate.Criterion;
using NHibernate.Util;
using NUnit.Framework;

namespace NHibernate.Test.SubselectFetchTest
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class SubselectFetchFixtureAsync : TestCase
	{
		protected override void Configure(Configuration cfg)
		{
			cfg.SetProperty(Cfg.Environment.GenerateStatistics, "true");
		}

		[Test]
		public async Task SubselectFetchHqlAsync()
		{
			ISession s = OpenSession();
			ITransaction t = s.BeginTransaction();
			Parent p = new Parent("foo");
			p.Children.Add(new Child("foo1"));
			p.Children.Add(new Child("foo2"));
			Parent q = new Parent("bar");
			q.Children.Add(new Child("bar1"));
			q.Children.Add(new Child("bar2"));
			ArrayHelper.AddAll(q.MoreChildren, p.Children);
			await (s.SaveAsync(p, CancellationToken.None));
			await (s.SaveAsync(q, CancellationToken.None));
			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			s = OpenSession();
			t = s.BeginTransaction();

			sessions.Statistics.Clear();

			IList parents = await (s.CreateQuery("from Parent where name between 'bar' and 'foo' order by name desc")
				.ListAsync(CancellationToken.None));
			p = (Parent) parents[0];
			q = (Parent) parents[1];

			Assert.IsFalse(NHibernateUtil.IsInitialized(p.Children));
			Assert.IsFalse(NHibernateUtil.IsInitialized(q.Children));

			Assert.AreEqual(p.Children.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(p.Children[0]));

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.Children));

			Assert.AreEqual(q.Children.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.Children[0]));

			Assert.IsFalse(NHibernateUtil.IsInitialized(p.MoreChildren));
			Assert.IsFalse(NHibernateUtil.IsInitialized(q.MoreChildren));

			Assert.AreEqual(p.MoreChildren.Count, 0);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.MoreChildren));

			Assert.AreEqual(q.MoreChildren.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.MoreChildren[0]));

			Assert.AreEqual(3, sessions.Statistics.PrepareStatementCount);

			Child c = (Child) p.Children[0];
			await (NHibernateUtil.InitializeAsync(c.Friends, CancellationToken.None));

			await (s.DeleteAsync(p, CancellationToken.None));
			await (s.DeleteAsync(q, CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();
		}

		[Test]
		public async Task SubselectFetchNamedParamAsync()
		{
			ISession s = OpenSession();
			ITransaction t = s.BeginTransaction();
			Parent p = new Parent("foo");
			p.Children.Add(new Child("foo1"));
			p.Children.Add(new Child("foo2"));
			Parent q = new Parent("bar");
			q.Children.Add(new Child("bar1"));
			q.Children.Add(new Child("bar2"));
			ArrayHelper.AddAll(q.MoreChildren, p.Children);
			await (s.SaveAsync(p, CancellationToken.None));
			await (s.SaveAsync(q, CancellationToken.None));
			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			s = OpenSession();
			t = s.BeginTransaction();

			sessions.Statistics.Clear();

			IList parents = await (s.CreateQuery("from Parent where name between :bar and :foo order by name desc")
				.SetParameter("bar", "bar")
				.SetParameter("foo", "foo")
				.ListAsync(CancellationToken.None));
			p = (Parent) parents[0];
			q = (Parent) parents[1];

			Assert.IsFalse(NHibernateUtil.IsInitialized(p.Children));
			Assert.IsFalse(NHibernateUtil.IsInitialized(q.Children));

			Assert.AreEqual(p.Children.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(p.Children[0]));

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.Children));

			Assert.AreEqual(q.Children.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.Children[0]));

			Assert.IsFalse(NHibernateUtil.IsInitialized(p.MoreChildren));
			Assert.IsFalse(NHibernateUtil.IsInitialized(q.MoreChildren));

			Assert.AreEqual(p.MoreChildren.Count, 0);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.MoreChildren));

			Assert.AreEqual(q.MoreChildren.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.MoreChildren[0]));

			Assert.AreEqual(3, sessions.Statistics.PrepareStatementCount);

			Child c = (Child) p.Children[0];
			await (NHibernateUtil.InitializeAsync(c.Friends, CancellationToken.None));

			await (s.DeleteAsync(p, CancellationToken.None));
			await (s.DeleteAsync(q, CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();
		}

		[Test]
		public async Task SubselectFetchPosParamAsync()
		{
			ISession s = OpenSession();
			ITransaction t = s.BeginTransaction();
			Parent p = new Parent("foo");
			p.Children.Add(new Child("foo1"));
			p.Children.Add(new Child("foo2"));
			Parent q = new Parent("bar");
			q.Children.Add(new Child("bar1"));
			q.Children.Add(new Child("bar2"));
			ArrayHelper.AddAll(q.MoreChildren, p.Children);
			await (s.SaveAsync(p, CancellationToken.None));
			await (s.SaveAsync(q, CancellationToken.None));
			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			s = OpenSession();
			t = s.BeginTransaction();

			sessions.Statistics.Clear();

			IList parents = await (s.CreateQuery("from Parent where name between ? and ? order by name desc")
				.SetParameter(0, "bar")
				.SetParameter(1, "foo")
				.ListAsync(CancellationToken.None));
			p = (Parent) parents[0];
			q = (Parent) parents[1];

			Assert.IsFalse(NHibernateUtil.IsInitialized(p.Children));
			Assert.IsFalse(NHibernateUtil.IsInitialized(q.Children));

			Assert.AreEqual(p.Children.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(p.Children[0]));

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.Children));

			Assert.AreEqual(q.Children.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.Children[0]));

			Assert.IsFalse(NHibernateUtil.IsInitialized(p.MoreChildren));
			Assert.IsFalse(NHibernateUtil.IsInitialized(q.MoreChildren));

			Assert.AreEqual(p.MoreChildren.Count, 0);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.MoreChildren));

			Assert.AreEqual(q.MoreChildren.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.MoreChildren[0]));

			Assert.AreEqual(3, sessions.Statistics.PrepareStatementCount);

			Child c = (Child) p.Children[0];
			await (NHibernateUtil.InitializeAsync(c.Friends, CancellationToken.None));

			await (s.DeleteAsync(p, CancellationToken.None));
			await (s.DeleteAsync(q, CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();
		}

		[Test]
		public async Task SubselectFetchWithLimitAsync()
		{
			ISession s = OpenSession();
			ITransaction t = s.BeginTransaction();
			Parent p = new Parent("foo");
			p.Children.Add(new Child("foo1"));
			p.Children.Add(new Child("foo2"));
			Parent q = new Parent("bar");
			q.Children.Add(new Child("bar1"));
			q.Children.Add(new Child("bar2"));
			Parent r = new Parent("aaa");
			r.Children.Add(new Child("aaa1"));
			await (s.SaveAsync(p, CancellationToken.None));
			await (s.SaveAsync(q, CancellationToken.None));
			await (s.SaveAsync(r, CancellationToken.None));
			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			s = OpenSession();
			t = s.BeginTransaction();

			sessions.Statistics.Clear();

			IList parents = await (s.CreateQuery("from Parent order by name desc")
				.SetMaxResults(2)
				.ListAsync(CancellationToken.None));
			p = (Parent) parents[0];
			q = (Parent) parents[1];
			Assert.IsFalse(NHibernateUtil.IsInitialized(p.Children));
			Assert.IsFalse(NHibernateUtil.IsInitialized(p.MoreChildren));
			Assert.IsFalse(NHibernateUtil.IsInitialized(q.Children));
			Assert.IsFalse(NHibernateUtil.IsInitialized(q.MoreChildren));
			Assert.AreEqual(p.MoreChildren.Count, 0);
			Assert.AreEqual(p.Children.Count, 2);
			Assert.IsTrue(NHibernateUtil.IsInitialized(q.Children));
			Assert.IsTrue(NHibernateUtil.IsInitialized(q.MoreChildren));

			Assert.AreEqual(3, sessions.Statistics.PrepareStatementCount);

			r = (Parent) await (s.GetAsync(typeof(Parent), r.Name, CancellationToken.None));
			Assert.IsTrue(NHibernateUtil.IsInitialized(r.Children)); // The test for True is the test of H3.2
			Assert.IsFalse(NHibernateUtil.IsInitialized(r.MoreChildren));
			Assert.AreEqual(r.Children.Count, 1);
			Assert.AreEqual(r.MoreChildren.Count, 0);

			await (s.DeleteAsync(p, CancellationToken.None));
			await (s.DeleteAsync(q, CancellationToken.None));
			await (s.DeleteAsync(r, CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();
		}

		[Test]
		public async Task ManyToManyCriteriaJoinAsync()
		{
			ISession s = OpenSession();
			ITransaction t = s.BeginTransaction();
			Parent p = new Parent("foo");
			p.Children.Add(new Child("foo1"));
			p.Children.Add(new Child("foo2"));
			Parent q = new Parent("bar");
			q.Children.Add(new Child("bar1"));
			q.Children.Add(new Child("bar2"));
			ArrayHelper.AddAll(q.MoreChildren, p.Children);
			await (s.SaveAsync(p, CancellationToken.None));
			await (s.SaveAsync(q, CancellationToken.None));
			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			s = OpenSession();
			t = s.BeginTransaction();

			await (s.CreateCriteria(typeof(Parent))
				.AddOrder(Order.Desc("Name"))
				// H3 has this after CreateCriteria("Friends"), but it's not yet supported in NH
				.CreateCriteria("MoreChildren")
				.CreateCriteria("Friends")
				.ListAsync(CancellationToken.None));

			IList parents = await (s.CreateCriteria(typeof(Parent))
				.SetFetchMode("MoreChildren", FetchMode.Join)
				.SetFetchMode("MoreChildren.Friends", FetchMode.Join)
				.AddOrder(Order.Desc("Name"))
				.ListAsync(CancellationToken.None));

			await (s.DeleteAsync(parents[0], CancellationToken.None));
			await (s.DeleteAsync(parents[1], CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();
		}

		[Test]
		public async Task SubselectFetchCriteriaAsync()
		{
			ISession s = OpenSession();
			ITransaction t = s.BeginTransaction();
			Parent p = new Parent("foo");
			p.Children.Add(new Child("foo1"));
			p.Children.Add(new Child("foo2"));
			Parent q = new Parent("bar");
			q.Children.Add(new Child("bar1"));
			q.Children.Add(new Child("bar2"));
			ArrayHelper.AddAll(q.MoreChildren, p.Children);
			await (s.SaveAsync(p, CancellationToken.None));
			await (s.SaveAsync(q, CancellationToken.None));
			await (t.CommitAsync(CancellationToken.None));
			s.Close();

			s = OpenSession();
			t = s.BeginTransaction();

			sessions.Statistics.Clear();

			IList parents = await (s.CreateCriteria(typeof(Parent))
				.Add(Expression.Between("Name", "bar", "foo"))
				.AddOrder(Order.Desc("Name"))
				.ListAsync(CancellationToken.None));
			p = (Parent) parents[0];
			q = (Parent) parents[1];

			Assert.IsFalse(NHibernateUtil.IsInitialized(p.Children));
			Assert.IsFalse(NHibernateUtil.IsInitialized(q.Children));

			Assert.AreEqual(p.Children.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(p.Children[0]));

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.Children));

			Assert.AreEqual(q.Children.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.Children[0]));

			Assert.IsFalse(NHibernateUtil.IsInitialized(p.MoreChildren));
			Assert.IsFalse(NHibernateUtil.IsInitialized(q.MoreChildren));

			Assert.AreEqual(p.MoreChildren.Count, 0);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.MoreChildren));

			Assert.AreEqual(q.MoreChildren.Count, 2);

			Assert.IsTrue(NHibernateUtil.IsInitialized(q.MoreChildren[0]));

			Assert.AreEqual(3, sessions.Statistics.PrepareStatementCount);

			Child c = (Child) p.Children[0];
			await (NHibernateUtil.InitializeAsync(c.Friends, CancellationToken.None));

			await (s.DeleteAsync(p, CancellationToken.None));
			await (s.DeleteAsync(q, CancellationToken.None));

			await (t.CommitAsync(CancellationToken.None));
			s.Close();
		}

		protected override IList Mappings
		{
			get { return new string[] {"SubselectFetchTest.ParentChild.hbm.xml"}; }
		}

		protected override string MappingsAssembly
		{
			get { return "NHibernate.Test"; }
		}

		//public override string CacheConcurrencyStrategy
		//{
		//    get { return null; }
		//}
	}
}
